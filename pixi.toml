"$schema" = "https://pixi.sh/v0.34.0/schema/manifest/schema.json"

[project]
name = "importnb"
channels = ["conda-forge"]
platforms = ["linux-64", "osx-64", "osx-arm64", "win-64"]

[tasks]
all = {description = """
run ALL non-interactive tasks to verify the project is ready to release""", depends-on = [
  "fix",
  "lint",
  "build",
  "test",
  "docs",
  "check",
], cmd = "echo ðŸš¢"}

fix = {description = """
apply ALL source formatting tools""", depends-on = [
  "fix-taplo",
  "fix-ruff",
  "fix-nbstripout",
], cmd = "echo ðŸ§¹"}

build = {description = """
build ALL distributions""", depends-on = ["build-lark", "build-pypi"], cmd = "echo ðŸ“¦"}

lint = {description = """
apply ALL static analysis tools""", depends-on = [
  "lint-ruff",
  "lint-mypy-src",
  "lint-mypy-dev",
  "lint-actionlint",
], cmd = "echo âœ…"}

test = {description = """
run ALL tests""", depends-on = ["test-pytest", "test-min-pytest"], cmd = "echo âœ…"}

docs = {description = """
build ALL documentation""", cmd = "echo ðŸ“ƒ", depends-on = ["docs-lite", "docs-mkdocs"]}

check = {description = """
perform ALL pre-release checks""", depends-on = [
  "check-links",
  "check-vale",
  "check-wheel",
  "check-twine",
], cmd = "echo ðŸ¤“"}

dev = {description = """start an interactive development environment""", depends-on = [
  "dev-lab",
], cmd = "echo ðŸŽ®"}

# fragments ####################################################################
pip-- = """python -m pip install
  -vv
  --no-deps
  --ignore-installed
  --no-build-isolation
  --disable-pip-version-check"""
pip-check-- = """
export FREEZES=build/reports/pip-freeze
&& export FROZEN=$FREEZES/$PIXI_ENVIRONMENT_NAME.txt
&& rm -rf $FROZEN
&& python -m pip check
&& mkdir -p $FREEZES
&& python -m pip list --format=freeze > $FROZEN
"""
pip-e-- = "pixi r pip-- -e . && pixi r pip-check--"
pip-whl-- = "pixi r pip-- --find-links=dist --no-index importnb && pixi r pip-check--"
pytest-- = """pytest
  --cov importnb
  --cov-branch
  --cov-context test
  --cov-report term-missing:skip-covered
  --no-cov-on-fail
  """
mkdocs-- = """export JUPYTER_PLATFORM_DIRS=1
&& mkdocs"""

# build ########################################################################
[feature.tasks-build.tasks.build-lark]
description = "... build the standalone JSON parser"
cmd = "python hatch_build.py > src/importnb/_json_parser.py"
inputs = ["src/importnb/json.g"]
outputs = ["src/importnb/_json_parser.py"]

[feature.tasks-build.tasks.build-pypi]
description = "... build the source and wheel distributions for PyPI"
cmd = """
rm -rf dist/
&& pyproject-build . --no-isolation
"""
depends-on = ["build-lark"]
inputs = [
  "{docs,src}/**/*.{g,ipy,ipynb,py}",
  "{README.md,LICENSE*,hatch_build.py,pyproject.toml}",
  "!**/coverage",
]
outputs = ["dist/*.{whl,tar.gz}"]

# test #########################################################################
[feature.tasks-test.tasks.test-setup]
description = "... install the package in an editable state for testing"
cmd = "pixi r -e test pip-e--"
outputs = ["build/reports/pip-freeze/test.txt"]
inputs = ["pyproject.toml"]

[feature.tasks-test.tasks.test-pytest]
description = "... run unit tests with coverage"
cmd = """pixi r -e test pytest--
  --cov-report=html:docs/coverage
  --self-contained-html
  --html=docs/pytest.html
"""
depends-on = ["test-setup"]
inputs = [
  "pyproject.toml",
  "{docs,src}/**/*.{g,ipy,ipynb,py}",
  "!**/.ipynb_checkpoints",
  "build/reports/pip-freeze/test.txt",
]

# test oldest ##################################################################
[feature.tasks-test-min.tasks.test-min-setup]
description = "... install the built wheel for testing in the oldest supported environment"
cmd = "pixi r -e test-min pip-whl--"
outputs = ["build/reports/pip-freeze/test-min.txt"]
inputs = ["dist/*.whl"]

[feature.tasks-test-min.tasks.test-min-pytest]
description = "... run tests in the oldest supported environemnt"
cmd = "pixi r -e test-min pytest--"
depends-on = ["test-min-setup"]
inputs = [
  "pyproject.toml",
  "{docs,src}/**/*.{g,ipy,ipynb,py}",
  "!**/.ipynb_checkpoints",
  "build/reports/pip-freeze/test-min.txt",
]

# docs #########################################################################
[feature.tasks-docs.tasks.docs-setup]
description = "... install the built package for documentation"
cmd = "pixi r -e docs pip-whl--"
depends-on = ["build-pypi"]
outputs = ["build/reports/pip-freeze/docs.txt"]
inputs = ["dist/*.whl"]

[feature.tasks-docs.tasks.docs-mkdocs]
description = "... build the documentation site"
cmd = "pixi r mkdocs-- build"
depends-on = ["docs-setup", "docs-lite"]
inputs = [
  "docs/",
  "src/",
  "build/lite/SHA256SUMS",
  "{mkdocs.yml,README.md,CONTRIBUTING.md}",
  "!**/{.ipynb_checkpoints,__pycache__,coverage,vale,mypy}/",
  "!docs/pytest.html",
]
outputs = ["site/", "!site/lite/"]

[feature.tasks-docs.tasks.docs-serve]
description = "... serve the documentation site"
cmd = "pixi r mkdocs-- serve"
depends-on = ["docs-mkdocs"]

[feature.tasks-docs.tasks.docs-rtd]
description = "... copy the documentation site to where ReadTheDocs wants it"
cmd = """
python -c "
import os;
assert all(map(os.getenv, ['READTHEDOCS', 'READTHEDOCS_OUTPUT'])), 'not on ReadTheDocs'
"
&& mkdir -p "$READTHEDOCS_OUTPUT"
&& cp -r site "$READTHEDOCS_OUTPUT/html"
&& ls "$READTHEDOCS_OUTPUT/html"
"""
depends-on = ["docs-mkdocs"]

# lite #########################################################################
[feature.tasks-lite.tasks.docs-lite]
description = "... build the JupyterLite demo"
cmd = """
export SOURCE_DATE_EPOCH=17302488620
&& cd lite
&& jupyter lite build
&& jupyter lite doit -- pre_archive:report:SHA256SUMS
"""
inputs = ["dist/*.whl", "lite/", "!**/*.doit*", "!**/{.ipynb_checkpoints,__pycache__}"]
outputs = ["build/lite/SHA256SUMS"]
depends-on = ["build-pypi"]

# lint #########################################################################
[feature.tasks-lint.tasks.lint-setup]
description = "... install the package in an editable state for static analysis"
cmd = "pixi r -e lint pip-e--"
inputs = ["pyproject.toml"]
outputs = ["build/reports/pip-freeze/lint.txt"]

[feature.tasks-lint.tasks.fix-nbstripout]
description = "... fix notebook JSON"
cmd = "nbstripout --keep-id --drop-empty-cells docs/*.ipynb"
inputs = ["docs/**/*.ipynb", "!**/.ipynb_checkpoints"]

[feature.tasks-lint.tasks.fix-ruff]
description = "... fix python source in notebooks and python files"
cmd = "ruff format && ruff check --fix-only"
inputs = ["pyproject.toml", "{docs,src}/**/*.{g,ipy,ipynb,py}", "!**/.ipynb_checkpoints"]

[feature.tasks-lint.tasks.fix-taplo]
description = "... fix toml files"
cmd = """taplo fmt
  *.toml
  --option=array_auto_collapse=true
  --option=compact_inline_tables=true
  --option=column_width=100"""
inputs = ["*.toml"]

[feature.tasks-lint.tasks.lint-mypy-src]
description = "... check python type hints for the shipped source code"
cmd = """
  rm -rf docs/mypy
  && mypy -p importnb --html-report docs/mypy"""
depends-on = ["lint-setup"]
inputs = [
  "build/reports/pip-freeze/lint.txt",
  "pyproject.toml",
  "src/**/*.py",
  "!**/.ipynb_checkpoints",
]
outputs = ["docs/mypy"]

[feature.tasks-lint.tasks.lint-mypy-dev]
description = "... check python type hints for tests and tools"
cmd = "mypy *.py docs/**/*.py lite/**/*.py"
depends-on = ["lint-setup"]
inputs = [
  "{docs,lite}/**/*.py",
  "*.py",
  "build/reports/pip-freeze/lint.txt",
  "pyproject.toml",
  "!**/.ipynb_checkpoints",
]

[feature.tasks-lint.tasks.lint-ruff]
description = "... check python and notebook source code style"
cmd = "ruff format --check && ruff check"
inputs = ["pyproject.toml", "{src,docs}/**/*.{py,ipynb}", "!**/.ipynb_checkpoints"]

[feature.tasks-lint.tasks.lint-actionlint]
description = "... check github actions workflows"
cmd = "actionlint -shellcheck=shellcheck -pyflakes=pyflakes"
inputs = [".github/workflows"]

# check ########################################################################
[feature.tasks-check.tasks.check-links]
description = "... check github hyperlinks in documentation"
cmd = """rm -rf build/reports/check-links
  && mkdir -p build/reports/check-links
  && cd build/reports/check-links
  && touch pytest.ini
  && pytest
    -vv
    -c pytest.ini
    -p no:warnings
    --rootdir=.
    --check-links
    --check-anchors
    --check-links-ignore '^https?://'
    -k "not (404 or coverage or lite or mypy or Untitled)"
    ../../../site/**/*.html"""
depends-on = ["docs-mkdocs"]
inputs = ["site/**/*.html"]

[feature.tasks-check.tasks.check-vale]
description = "... check spelling in documentation"
cmd = "python docs/vale/check.py"
depends-on = ["docs-mkdocs"]
inputs = ["site/{index,contributing/}.html", "docs/vale", "src/**/*.py", "!**/.ipynb_checkpoints"]

[feature.tasks-check.tasks.check-wheel]
description = "... check the built wheel"
cmd = "check-wheel-contents dist/*.whl"
depends-on = ["build-pypi"]
inputs = ["dist/*.whl"]

[feature.tasks-check.tasks.check-twine]
description = "... check the built distributions for PyPI"
cmd = "twine check --strict dist/*.whl dist/*.tar.gz"
depends-on = ["build-pypi"]
inputs = ["dist/"]

# dev ##########################################################################
[feature.tasks-dev.tasks.dev-setup]
description = "... prepare for interactive development"
cmd = "pixi r -e dev pip-e--"
outputs = ["build/reports/pip-freeze/dev.txt"]
inputs = ["pyproject.toml"]

[feature.tasks-dev.tasks.dev-lab]
description = "... launch JupyterLab"
cmd = "jupyter lab --no-browser --debug --config=docs/jupyter_config.json"
depends-on = ["dev-setup"]

# envs #########################################################################
[environments]
build = ["deps-build", "tasks-build"]
test = ["deps-build", "deps-pip", "deps-run-interactive", "deps-run", "deps-test", "tasks-test"]
test-min = [
  "deps-build",
  "deps-pip",
  "deps-run-interactive-oldest",
  "deps-run-interactive",
  "deps-run-oldest",
  "deps-run",
  "deps-test-min",
  "deps-test",
  "tasks-test-min",
]
docs = ["deps-docs", "deps-build", "deps-run", "deps-pip", "tasks-docs"]
lite = ["deps-lab", "deps-lite", "tasks-lite"]
lint = [
  "deps-build",
  "deps-docs",
  "deps-lint",
  "deps-pip",
  "deps-run-interactive",
  "deps-run",
  "deps-test",
  "tasks-lint",
]
check = ["deps-check", "tasks-check"]
dev = [
  "deps-build",
  "deps-check",
  "deps-dev",
  "deps-docs",
  "deps-lab",
  "deps-lint",
  "deps-pip",
  "deps-run-interactive",
  "deps-run",
  "deps-test",
  "tasks-dev",
]

# deps #########################################################################
[feature.deps-run.dependencies]
importlib-metadata = ">=4.8.3"

[feature.deps-run-oldest.dependencies]
importlib-metadata = "4.8.3"
python = "3.9.*"

[feature.deps-run-interactive.dependencies]
ipython = "*"

[feature.deps-run-interactive-oldest.dependencies]
ipython = "8.7.*"

[feature.deps-build.dependencies]
hatchling = "*"
hatch-vcs = "*"
lark = "*"
python-build = "*"

[feature.deps-pip.dependencies]
pip = "*"

[feature.deps-lint.dependencies]
actionlint-with-all = "*"
lxml = "*"
mypy = "1.13.*"
nbstripout = "*"
ruff = "0.7.*"
taplo = "*"
types-pyyaml = "*"
beartype = "*"

[feature.deps-test.dependencies]
"ruamel.yaml" = "*"
coverage = "*"
doit = "*"
pytest = "*"
pytest-cov = "*"
pytest-html = "*"
pytest-xdist = "*"
tomli-w = "*"

[feature.deps-test-min.dependencies]
pytest = "7.0.*"

[feature.deps-docs.dependencies]
mkdocs-jupyter = "*"
mkdocs-material = "*"
mkdocstrings = "*"
mkdocstrings-python = "*"
"ruamel.yaml" = "*"

[feature.deps-lab.dependencies]
ipywidgets = "*"
jupyterlab = "*"
notebook = "*"

[feature.deps-dev.dependencies]
beartype = "*"
jupyterlab-lsp = "*"
pylsp-mypy = "*"
python-lsp-ruff = "*"
vale-ls = "*"

[feature.deps-lite.dependencies]
jupyterlite-core = "0.4.3"
jupyterlite-pyodide-kernel = "0.4.3"
jupyterlite-core-with-translation = "*"
jupyterlite-core-with-libarchive = "*"

[feature.deps-check.dependencies]
check-wheel-contents = "*"
pytest-check-links = "*"
pytest-html = "*"
twine = "*"
vale = "*"
vale-spelling-aoo-mozilla-en-dict-us = "*"
